@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Forms
@using Newtonsoft.Json;
@using StellarJadeManager.Client.Authentication;
@using StellarJadeManager.Shared;
@using System.Text;
@inject HttpClient http
@inject AuthenticationStateProvider authStateProvider
@inject Blazored.LocalStorage.ILocalStorageService localStorage
@inject Blazored.SessionStorage.ISessionStorageService sessionStorage
@inject NavigationManager Navigation


<MudContainer Class="d-flex justify-center flex-column align-center" Style="with:50%; height:100%">
    <MudText Typo="Typo.h4">Регистрация</MudText>
    <EditForm Model="@registrationModel" OnValidSubmit="HandleRegistration">
        <MudContainer MaxWidth="MaxWidth.Medium" Class="d-flex flex-column justify-space-around">
            <MudTextField Class="my-2" @bind-Value="registrationModel.Name" Label="Name" For="@(() => registrationModel.Name)" FullWidth Variant="Variant.Filled" />
            <MudTextField Class="my-2" @bind-Value="registrationModel.Email" Label="Email" For="@(() => registrationModel.Email)" FullWidth Variant="Variant.Filled" />
            <MudTextField Class="my-2" @bind-Value="registrationModel.Password" Label="Password" For="@(() => registrationModel.Password)" InputType="InputType.Password" FullWidth Variant="Variant.Filled" />
            <MudButton Disabled="_processing" Class="my-4" ButtonType="ButtonType.Submit" Color="MudBlazor.Color.Primary" Variant="Variant.Filled">
                @if (_processing)
                {
                    <MudProgressCircular Class="ms-n1" Size="MudBlazor.Size.Small" Indeterminate="true" />
                    <MudText Class="ms-2">Регистрация...</MudText>
                }
                else
                {
                    <MudText>Зарегистрироваться</MudText>
                }
            </MudButton>
        </MudContainer>
    </EditForm>
</MudContainer>


@*

<MudPaper Elevation="2" Class="pa-4 mx-auto" Style="max-width: 500px;">
    <MudText Typo="Typo.h4" GutterBottom="true">Register</MudText>
    <EditForm Model="@registrationModel" OnValidSubmit="HandleRegistration">
        <MudTextField @bind-Value="registrationModel.Name" Label="Name" For="@(() => registrationModel.Name)" FullWidth Variant="Variant.Filled" />
        <MudTextField @bind-Value="registrationModel.Email" Label="Email" For="@(() => registrationModel.Email)" FullWidth Variant="Variant.Filled" />
        <MudTextField @bind-Value="registrationModel.Password" Label="Password" For="@(() => registrationModel.Password)" InputType="InputType.Password" FullWidth Variant="Variant.Filled" />

        <MudButton ButtonType="ButtonType.Submit" Color="MudBlazor.Color.Primary" Variant="Variant.Filled" Class="mt-4">Register</MudButton>
    </EditForm>
</MudPaper>
*@

@code {
    private UserRegistrationDTO registrationModel = new UserRegistrationDTO();
    private bool _processing = false;
    private async Task HandleRegistration()
    {
        _processing = true;
        var json = JsonConvert.SerializeObject(registrationModel);
        var jsonContent = new StringContent(json, Encoding.UTF8, "application/json");
        var response = await http.PostAsync("/api/user/register", jsonContent);
        var json_response = await response.Content.ReadAsStringAsync();
        if (response.IsSuccessStatusCode)
        {

            var session = JsonConvert.DeserializeObject<UserSession>(json_response);
            var customAuthStateProvider = (CustomAuthenticationStateProvider)authStateProvider;
            await customAuthStateProvider.UpdateAuthenticationState(session);
            StateHasChanged();
            _processing = false;
            Navigation.NavigateTo("/");
        }
        else
        {
            Console.WriteLine(json_response);
            _processing = false;
        }
    }


}
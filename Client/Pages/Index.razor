@page "/"
@using StellarJadeManager.Client.Components.MainPage
@using System.Text

@inject HttpClient Http
@inject IMapper _mapper
@inject AuthenticationStateProvider authStateProvider

<Calendar
    patches="patches"
    OnSelectedDateChanged="UpdateSelectedDate"
    selectedDate="profiles?.First()?.SelectedDate??DateTime.Today"
></Calendar>
<Calculator
    patches="patches"
    chances="chances"
    currentGems="profiles?.First()?.CurrentJades??0"
    selectedDate="profiles?.First()?.SelectedDate??DateTime.Today"
    month_pass="profiles?.First()?.SupplyPass??false"
    MoC_stars="profiles?.First()?.MoCStars??0"
    PF_stars="profiles?.First()?.PfStars??0"
    OnProfileDataChanged="UpdateProfileData"
></Calculator>



@code{
    [CascadingParameter]
    private Task<AuthenticationState> AuthenticationStateTask { get; set; }
    [CascadingParameter]
    List<Shared.Profile> profiles { get; set; }


    public Dictionary<int, double> chances = new();
    public List<PatchDTO> patches;

    public async Task UpdateProfileData(ProfilePutRequestDTO profile){

        _mapper.Map(profile, profiles[0]);
        await UpdateProfile(profiles?.First()?.Id??-1, profile);
    }

    public async Task UpdateSelectedDate(DateTime selectedDate){
        if(profiles==null || profiles.Count<1){
            return;
        }
        profiles[0].SelectedDate = selectedDate;
        await UpdateProfile(profiles[0].Id, new ProfilePutRequestDTO() { SelectedDate = selectedDate });
    }

    public async Task UpdateProfile(int id, ProfilePutRequestDTO profile){
        if(profile==null){
            return;
        }
        var authState = await AuthenticationStateTask;
        var user = authState.User;
        if (user?.Identity.IsAuthenticated ?? false)
        {
            var json = JsonConvert.SerializeObject(profile);
            var jsonContent = new StringContent(json, Encoding.UTF8, "application/json");
            var response = await Http.PutAsync($"api/profile/{id}", jsonContent);
            var json_response = await response.Content.ReadAsStringAsync();
            @* StateHasChanged(); *@

        }
    }

    protected override async Task OnInitializedAsync(){
        //симуляция сервака с мл, коэфы регрессии
        var const_a = 3623.0/850; 
        var b = -497.0/8500;
        for (int roll_num = 1;roll_num <= 90; roll_num++){
            if(roll_num == 90){
                chances.Add(roll_num, 1);
            }
            else if(roll_num < 74){
                chances.Add(roll_num, 0.006);
            }
            else{
                chances.Add(roll_num, b*roll_num + const_a);
            }
        }   
        patches = await Http.GetFromJsonAsync<List<PatchDTO>>("/api/patches") ?? new();
        StateHasChanged();

    }
 }